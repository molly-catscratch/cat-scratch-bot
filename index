// Replace your existing date/time picker handlers with these updated versions:

// Date picker handler - FIXED
app.action('date_picker', async ({ ack, body, client }) => {
  await ack();
  const userId = body.user.id;
  const selectedDate = body.actions[0].selected_date;

  let data = formData.get(userId) || {};
  data.date = selectedDate;
  data.scheduleType = 'schedule'; // Selecting date implies scheduling
  formData.set(userId, data);

  console.log(`üìÖ Date selected: ${selectedDate} for user ${userId}`);

  // Optional UX: refresh modal so user sees selection immediately
  try {
    await client.views.update({
      view_id: body.view.id,
      view: createModal('schedule', data)
    });
  } catch (e) {
    console.log('Could not refresh modal after date selection (safe to ignore).');
  }
});

// Time picker handler - FIXED
app.action('time_picker', async ({ ack, body, client }) => {
  await ack();
  const userId = body.user.id;
  const selectedTime = body.actions[0].selected_time;

  let data = formData.get(userId) || {};
  data.time = selectedTime;
  data.scheduleType = 'schedule'; // Selecting time implies scheduling
  formData.set(userId, data);

  console.log(`‚è∞ Time selected: ${selectedTime} for user ${userId}`);

  // Optional UX: refresh modal so user sees selection immediately
  try {
    await client.views.update({
      view_id: body.view.id,
      view: createModal('schedule', data)
    });
  } catch (e) {
    console.log('Could not refresh modal after time selection (safe to ignore).');
  }
});

// Also update your navigation handler to use the correct extraction:
// Find the nav handler section and replace the schedule extraction with:

// Extract schedule-specific data when going to/from schedule page
if (page === 'schedule' || page === 'preview') {
  data.channel = getFormValue(values, 'channel_block', 'channel_select', 'conversation') || data.channel;
  // FIXED: Use the new separate block IDs
  data.date = getFormValue(values, 'date_block', 'date_picker', 'date') || data.date;
  data.time = getFormValue(values, 'time_block', 'time_picker', 'time') || data.time;
  data.repeat = getFormValue(values, 'repeat_block', 'repeat_select', 'selected') || data.repeat || 'none';
}
